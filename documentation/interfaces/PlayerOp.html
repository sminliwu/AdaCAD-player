<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>adacad-weaver documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">adacad-weaver documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li>Interfaces</li>
  <li
  >
  PlayerOp</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/player/model/op_mappings.ts</code>
        </p>




        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#chain" 
>
                                            chain
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#dx" 
>
                                            dx
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#id" 
>
                                            id
                                        </a>
                                </li>
                                <li>
                                        <a href="#name" 
>
                                            name
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#op" 
>
                                            op
                                        </a>
                                </li>
                                <li>
                                        <a href="#perform" 
>
                                            perform
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#struct_id" 
>
                                            struct_id
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#weavingOnly" 
>
                                            weavingOnly
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="chain"></a>
                                        <span class="name "><b>chain</b>
                                            <a href="#chain">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>chain:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="dx"></a>
                                        <span class="name "><b>dx</b>
                                            <a href="#dx">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>dx:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="id"></a>
                                        <span class="name "><b>id</b>
                                            <a href="#id">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>id:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="name"></a>
                                        <span class="name "><b>name</b>
                                            <a href="#name">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>name:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="op"></a>
                                        <span class="name "><b>op</b>
                                            <a href="#op">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>op:     <code>GenericOp</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>GenericOp</code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="perform"></a>
                                        <span class="name "><b>perform</b>
                                            <a href="#perform">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>perform:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="struct_id"></a>
                                        <span class="name "><b>struct_id</b>
                                            <a href="#struct_id">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>struct_id:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="weavingOnly"></a>
                                        <span class="name "><b>weavingOnly</b>
                                            <a href="#weavingOnly">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>weavingOnly:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Draft } from &quot;../../core/model/datatypes&quot;;
import { wefts } from &quot;../../core/model/drafts&quot;;
import { OpInput, TreeOperation as TreeOp, SingleInlet,
  BaseOp as Op, BuildableOperation as GenericOp, 
  Seed, Pipe, AllRequired, DraftsOptional, 
  getDefaultParams, 
  ParamValue
} from &quot;../../mixer/model/operation&quot;;
import { PlayerState, initState, copyState } from &quot;./state&quot;;

import { OpSequencer, makeOpSequencer } from &quot;./sequencer&quot;;
export * from &quot;./sequencer&quot;;

export interface PlayerOp {
  id?: number,
  name: string,
  struct_id?: number,
  dx?: string,
  op?: GenericOp,
  weavingOnly?: boolean,
  chain?: boolean,
  perform: (init: PlayerState) &#x3D;&gt; Promise&lt;PlayerState&gt;;
}
export type SingleOp &#x3D; PlayerOp;

/** @const forward a player-specific function to progress through the draft */
export const forward: PlayerOp &#x3D; {
  name: &#x27;forward&#x27;,
  perform: (init: PlayerState) &#x3D;&gt; { 
    let res &#x3D; copyState(init);
    res.row &#x3D; (init.row+1) % wefts(init.draft.drawdown);
    res.pedal &#x3D; &#x27;forward&#x27;;
    if (res.weaving) res.numPicks++;
    return Promise.resolve(res); 
  }
}

/** @const refresh a player-specific function to progress through the draft (re-sends the row to give more time) */
export const refresh: PlayerOp &#x3D; {
  name: &#x27;refresh&#x27;,
  perform: (init: PlayerState) &#x3D;&gt; { 
    let res &#x3D; copyState(init);
    if (res.weaving) res.numPicks++;
    return Promise.resolve(res);
  }
}

/** @const reverse a player-specific function to progress backwards through the draft */
export const reverse: PlayerOp &#x3D; {
  name: &#x27;reverse&#x27;,
  perform: (init: PlayerState) &#x3D;&gt; { 
    let res &#x3D; copyState(init);
    res.row &#x3D; (init.row+wefts(init.draft.drawdown)-1) % wefts(init.draft.drawdown);
    res.pedal &#x3D; &#x27;reverse&#x27;;
    if (res.weaving) res.numPicks++;
    return Promise.resolve(res);
  }
}

export function playerOpFrom(op: GenericOp, params?: Array&lt;ParamValue&gt;) {
  // use &quot;rotate&quot; op as an example
  let input_params &#x3D; params ? params : getDefaultParams(op);
  let perform;
  if (op.classifier.type &#x3D;&#x3D;&#x3D; &#x27;pipe&#x27;) {
    const pipeOp &#x3D; op as Op&lt;Pipe, AllRequired&gt;;
    perform &#x3D; function(init: PlayerState) {
      let res &#x3D; copyState(init);
      res.draft &#x3D; pipeOp.perform(init.draft, input_params);
      res.row &#x3D; (init.row) % wefts(res.draft.drawdown);
      res.pedal &#x3D; op.name;
      return Promise.resolve(res);
    }
  } else if (op.classifier.type &#x3D;&#x3D;&#x3D; &#x27;seed&#x27;) {
    const seedOp &#x3D; op as Op&lt;Seed, DraftsOptional&gt;;
    perform &#x3D; function(init: PlayerState) {
      let res &#x3D; copyState(init);
      res.draft &#x3D; seedOp.perform(input_params);
      res.row &#x3D; (init.row) % wefts(res.draft.drawdown);
      res.pedal &#x3D; op.name;
      return Promise.resolve(res);
    }
  }
  
  /** @TODO */
  var p: PlayerOp &#x3D; { 
    name: op.name,
    dx: op.dx,
    perform: perform
  }
  return p;
}


/** 
 * @type 
 * a TreeOperation is compatible with the player if it takes one or zero draft inputs 
 * and outputs one draft.
 */
type PlayableTreeOp &#x3D; TreeOp &amp; 
  ( { inlets: [ SingleInlet ] } | 
    { inlets: [] });

/** @function playerOpFromTree (untested) */
function playerOpFromTree(op: PlayableTreeOp) {
  let perform: PlayerOp[&quot;perform&quot;];
  let param_input: OpInput &#x3D; { op_name: op.name, drafts: [], params: getDefaultParams(op), inlet: -1 }
  if (op.inlets.length &#x3D;&#x3D; 0) {
    perform &#x3D; function(init: PlayerState) {
      return op.perform([param_input]).then((output) &#x3D;&gt; {
        return { 
          draft: output[0], 
          row: init.row, 
          weaving: init.weaving, 
          pedal: op.name, 
          numPicks: init.numPicks 
        };
      });
    }
  } else {
    perform &#x3D; function(init: PlayerState) {
      let draft_input: OpInput &#x3D; { op_name: &#x27;child&#x27;, drafts: [init.draft], params: [], inlet: 0}
      return op.perform([param_input, draft_input]).then((output) &#x3D;&gt; {
        return { 
          draft: output[0], 
          row: init.row, 
          weaving: init.weaving,
          pedal: op.name,
          numPicks: init.numPicks };
      });
    }
  }

  var p: PlayerOp &#x3D; { 
    name: op.name,
    perform: perform
  }
  return p;
}

/** things that can happen in response to a pedal */
export interface PedalEvent {
  id?: number,
  pedal?: number,
  name: string
  perform: (init: PlayerState, ...args) &#x3D;&gt; Promise&lt;PlayerState&gt;;
}

/** 
 * Basic combination: 
 *  - 1 pedal, 1 operation
 *  - if pedal, then operation perform() 
 * @param pedal ID number of pedal
 * @param op    ID number of Operation (assigned in Draft Player service)
 */
export interface PairedOp extends PedalEvent {
  pedal:  number,
  op:     PlayerOp,
}

// this ...args thing is such a hack
export function makePairedOp(p: number, op: PlayerOp): PairedOp {
  let jankPerform &#x3D; (init: PlayerState, ...args) &#x3D;&gt; {
    return op.perform(init);
  }
  return {
    pedal: p,
    name: op.name,
    op: op,
    perform: jankPerform
  }
}

/**
 * Op chain:
 * - 1 pedal, multiple operations in a chain (array)
 * - if pedal, perform() each Op in sequence
 * @param pedal ID number of pedals
 * @param ops   array of Op ID numbers to execute in order
 */
export interface ChainOp extends PedalEvent{
  pedal:  number,
  ops:    Array&lt;PlayerOp&gt;,
}

export function makeBlankChainOp(p?: number): ChainOp {
  let res: ChainOp &#x3D; {
    pedal: -1,
    name: &quot;&quot;,
    ops: [],
    perform: (init: PlayerState, ...args) &#x3D;&gt; {return Promise.resolve(init);}
  }
  
  if (p) res.pedal &#x3D; p;
  return res;
}

export function makeChainOp(ops: Array&lt;PlayerOp&gt;, p?: number): ChainOp {
  let res &#x3D; makeBlankChainOp(p);
  res.name &#x3D; &quot;ch&quot;;
  for (let o of ops) {
    res.name +&#x3D; &quot;-&quot; + o.name;
  }

  res.ops &#x3D; ops;
  res.perform &#x3D; (init: PlayerState, ...args) &#x3D;&gt; {
    let newState &#x3D; copyState(init);
    newState.pedal &#x3D; &quot;ch&quot;;
    let d: Draft &#x3D; init.draft;
    for (let o of ops) {
      if (o.op.classifier.type &#x3D;&#x3D; &#x27;seed&#x27;) {
        let base_op &#x3D; o.op as Op&lt;Seed, DraftsOptional&gt;;
        d &#x3D; base_op.perform(getDefaultParams(base_op));
      } else if (o.op.classifier.type &#x3D;&#x3D; &#x27;pipe&#x27;) {
        let base_op &#x3D; o.op as Op&lt;Pipe, AllRequired&gt;;
        d &#x3D; base_op.perform(d, getDefaultParams(base_op));
      }
      newState.pedal +&#x3D; &quot;-&quot; + o.name;
    }

    newState.draft &#x3D; d;

    return Promise.resolve(newState);
  }

  console.log(&#x27;op chain: &#x27;, res);

  return res;
}

export type PedalOpMapping &#x3D; Array&lt;PedalAction&gt;;// &amp; {
//   [id: number]: PedalAction
// }

export type MappingShapes &#x3D; {
  &#x27;pairing&#x27;: PairedOp,
  &#x27;chain&#x27;: ChainOp,
  &#x27;sequencer&#x27;: OpSequencer
};

export type PedalAction &#x3D; MappingShapes[keyof MappingShapes];

export type MappingType &#x3D; &#x27;pairing&#x27; | &#x27;chain&#x27; | &#x27;sequencer&#x27;;</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'PlayerOp.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
